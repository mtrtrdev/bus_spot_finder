<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- タイトルはJSで更新 -->
  <title>Loading...</title>
  <!-- キャッシュ防止 -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          kyoto: {
            50: '#FDF8F6',    // 例: 薄い色
            100: '#FDECE7',   // 例: やや薄い色
            200: '#FAD1C5',   // 例: 少し濃い色
            500: '#D4762A',   // 例: 主要な色 (現在の gradient-bg のオレンジに近い)
            600: '#C76A22',   // 例: ホバー時の色など
            800: '#9C581E',   // 例: テキスト色など
          },
        }
      }
    }
  }
</script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
    }
    #map {
      width: 100%;
      height: 400px;
      border-radius: 12px;
      box-shadow: 0 4px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
    }
    @media (min-width: 768px) {
      #map { height: 500px; }
    }
    @media (min-width: 1024px) {
      #map { height: 600px; }
    }
    .ai-response { white-space: pre-wrap; line-height: 1.6; }
    .loading-dots::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }
    @keyframes dots {
      0%,20% { content: '.'; }
      40% { content: '..'; }
      60% { content: '...'; }
      80%,100% { content: ''; }
    }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    /* サイドメニューのスクロール設定 */
    #busStopList {
      max-height: 600px;
      overflow-y: auto;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-kyoto-50 to-kyoto-100 min-h-screen">
  <!-- ヘッダー -->
  <header class="gradient-bg text-white shadow-lg">
    <div class="container mx-auto px-4 py-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
            </svg>
          </div>
          <div>
            <!-- サイトタイトル、サブタイトルはJSで更新 -->
            <h1 class="text-2xl md:text-3xl font-bold" id="siteTitle">Loading...</h1>
            <p class="text-sm md:text-base text-white text-opacity-90" id="siteSubtitle"></p>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- メインコンテンツ -->
  <main class="container mx-auto px-4 py-8">
    <!-- 説明カード -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8 border border-kyoto-200">
      <div class="flex items-start space-x-4">
        <div class="flex-shrink-0 w-12 h-12 bg-kyoto-500 rounded-full flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <div class="flex-1">
          <h2 class="text-lg font-semibold text-gray-800 mb-2">説明 & 使い方</h2>
          <p class="text-gray-600 leading-relaxed">
            地図上の任意の場所をクリックすると、その地点を中心とした
            <span class="inline-block bg-kyoto-100 text-kyoto-800 px-2 py-1 rounded-full text-sm font-medium">半径500m以内</span>
            のスポットを検索します。各スポットにはAIによる詳細説明も表示されます。
          </p>
          <p class="text-gray-600 leading-relaxed" id="siteDescription">
            <!-- 説明文はJSで mapConfig.description を挿入 -->
          </p>
        </div>
      </div>
    </div>

    <!-- プリセット選択（リッチデザイン） -->
    <div class="bg-gradient-to-r from-kyoto-100 to-kyoto-200 rounded-2xl shadow-xl p-6 md:p-8 mb-8 border border-kyoto-200">
      <div class="flex items-center space-x-4 mb-3">
        <div class="w-10 h-10 bg-kyoto-500 rounded-full flex items-center justify-center shadow-md">
          <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
          </svg>
        </div>
        <div>
          <span class="text-lg font-semibold text-kyoto-800">市バス系統選択</span>
          <p class="text-sm text-gray-500 mt-1">主要なバス路線を系統で選択してスポット検索が可能です。</p>
        </div>
      </div>
      <div class="flex items-center space-x-3">
        <label for="presetSetSelector" class="text-kyoto-800 font-semibold whitespace-nowrap">系統</label>
        <select id="presetSetSelector" class="w-full md:w-auto border-kyoto-500 border-2 rounded-lg px-4 py-2 text-gray-800 bg-white focus:ring-2 focus:ring-kyoto-500 focus:outline-none shadow-sm transition duration-150 ease-in-out hover:border-kyoto-600">
        </select>
      </div>
    </div>

    <!-- 地図とサイドメニューを横並びにするコンテナ -->
    <div class="flex flex-col md:flex-row gap-4 mb-8">
      <!-- 左側：地図 -->
      <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 flex-1">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold text-gray-800">地図</h3>
          <div class="flex items-center space-x-2 text-sm text-gray-500">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
            </svg>
            <span>クリックして検索</span>
          </div>
        </div>
        <div id="map" class="rounded-lg overflow-hidden" style="height: 600px;"></div>
      </div>
      <!-- 右側：サイドメニュー（バス停一覧） -->
      <div id="busStopMenu" class="bg-white rounded-xl shadow-lg p-4 md:p-6 w-full md:w-1/3">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">バス停一覧</h3>
        <ul id="busStopList" class="space-y-2"></ul>
      </div>
    </div>

    <!-- 検索結果セクション -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
      <div class="bg-gradient-to-r from-kyoto-500 to-kyoto-600 px-6 py-4">
        <h2 class="text-xl font-semibold text-white flex items-center">
          <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
          </svg>
          検索結果
        </h2>
      </div>
      <div class="p-6">
        <div id="searchResultsList" class="space-y-4">
          <div class="text-center py-12">
            <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <p class="text-gray-500 text-lg">地図をクリックして検索を開始してください</p>
            <p class="text-gray-400 text-sm mt-2">スポットを探してみましょう</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- フッター -->
  <footer class="bg-gray-800 text-white py-8 mt-16">
    <div class="container mx-auto px-4 text-center">
      <p class="text-gray-400">&copy; 2025</p>
    </div>
  </footer>
  
  <!-- 渡された dataset をJS変数にセット -->
  <script>
    const currentDataset = "{{ dataset }}";
  </script>

<script>
  let map;
  let searchCircle;
  let searchMarkers = [];
  let presetMarkers = [];
  let mapConfig = {};

  async function loadMapConfig() {
    try {
      const response = await fetch('/get_map_config?dataset=' + encodeURIComponent(currentDataset));
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      mapConfig = await response.json();
      console.log("Map Config loaded:", mapConfig); // デバッグ用
      document.getElementById('siteTitle').textContent = mapConfig.siteInfo.title || "サイトタイトル";
      document.getElementById('siteSubtitle').textContent = mapConfig.siteInfo.subtitle || "";

      // バス系統セレクターの初期化
      const presetSelector = document.getElementById('presetSetSelector');
      presetSelector.innerHTML = "";
      Object.keys(mapConfig.busStops).forEach(key => {
        const option = document.createElement("option");
        option.value = key;
        option.text = key;
        presetSelector.appendChild(option);
      });
      presetSelector.value = Object.keys(mapConfig.busStops)[0];
      presetSelector.addEventListener('change', (e) => {
        setPresetMarkers(e.target.value);
      });

      if (mapConfig.themes && mapConfig.themes.defaultTheme && mapConfig.themes.options && mapConfig.themes.options[mapConfig.themes.defaultTheme]) {
        window.selectedTheme = mapConfig.themes.defaultTheme;
        console.log("デフォルトテーマが設定されました:", window.selectedTheme);
      } else {
        window.selectedTheme = null; 
        console.warn("mapConfigにデフォルトテーマが適切に定義されていないため、テーマは設定されません。");
      }

      document.getElementById('siteDescription').textContent = mapConfig.siteInfo.description || "";

    } catch (error) {
      console.error("Failed to load map config:", error);
      document.getElementById('siteTitle').textContent = "設定読み込みエラー";
      document.getElementById('siteSubtitle').textContent = "コンソールを確認してください";
    }
  }
  
  function populateBusStopList(setName) {
    const busStopList = document.getElementById('busStopList');
    busStopList.innerHTML = "";
    const stops = mapConfig.busStops[setName];
    stops.forEach((stop, index) => {
      const li = document.createElement("li");
      li.id = "busStopItem-" + index;
      li.className = "cursor-pointer p-2 rounded hover:bg-gray-200";
      li.textContent = stop.name;
      li.dataset.system = setName;
      li.dataset.busStopName = stop.name; // バス停名をデータ属性に追加
      li.addEventListener("click", () => {
        if (presetMarkers[index]) {
          map.panTo(presetMarkers[index].getPosition());
          map.setZoom(17);
        }
        const system = li.dataset.system;
        const busStopName = li.dataset.busStopName;
        performNearbySearch(presetMarkers[index].getPosition(), system, busStopName);
        highlightBusStopItem(index);
      });
      busStopList.appendChild(li);
    });
  }
  
  function highlightBusStopItem(index) {
    const busStopItems = document.querySelectorAll("#busStopList li");
    busStopItems.forEach((item, i) => {
      if (i === index) {
        item.classList.add("bg-green-200");
        item.scrollIntoView({ behavior: "smooth", block: "center" });
      } else {
        item.classList.remove("bg-green-200");
      }
    });
  }
  
  function setPresetMarkers(setName) {
    presetMarkers.forEach(marker => marker.setMap(null));
    presetMarkers = [];
    mapConfig.busStops[setName].forEach((preset, index) => {
      const marker = new google.maps.Marker({
        position: { lat: preset.lat, lng: preset.lng },
        map: map,
        title: preset.name,
        icon: mapConfig.isAdminMode ? undefined : "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
      });
      marker.addListener('click', () => {
        const system = setName;
        const busStopName = preset.name; // マーカーからバス停名を取得
        performNearbySearch(marker.getPosition(), system, busStopName);
        highlightBusStopItem(index);
      });
      presetMarkers.push(marker);
    });
    populateBusStopList(setName);
  }
  
  async function initMap() {
    await loadMapConfig();
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: mapConfig.map.initialLat, lng: mapConfig.map.initialLng },
      zoom: mapConfig.map.zoom,
      mapTypeControl: false,
      streetViewControl: false
    });
    if (mapConfig.isAdminMode) {
      map.addListener("click", (e) => {
        performNearbySearch(e.latLng, null, "地図クリック");
      });
    } else {
      map.addListener("click", (e) => {
        console.log("非管理者モード: マップクリックは無効");
      });
    }
    setPresetMarkers(Object.keys(mapConfig.busStops)[0]);
  }
  
  function clearSearchResults() {
    searchMarkers.forEach(marker => marker.setMap(null));
    searchMarkers = [];
    if (searchCircle) {
      searchCircle.setMap(null);
      searchCircle = null;
    }
    document.getElementById('searchResultsList').innerHTML = `<div class="text-center py-12">
      <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
      </svg>
      <p class="text-gray-500 text-lg">地図をクリックして検索を開始してください</p>
    </div>`;
    console.log("Cleared previous search results.");
  }
  
  async function requestGeminiDescription(place) {
    try {
      const response = await fetch("/generate_description", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: place.name,
          address: place.vicinity || place.formatted_address || "所在地不明",
          dataset: currentDataset,
        })
      });
      const data = await response.json();
      return data.description || "回答の生成に失敗しました。";
    } catch (error) {
      console.error("Error fetching generate_description:", error);
      return "生成中にエラーが発生しました。";
    }
  }
  
  async function performNearbySearch(centerLatLng, system, busStopName) {
    clearSearchResults();
    document.getElementById('searchResultsList').innerHTML = `<div class="text-center py-12">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-kyoto-500 mb-4"></div>
      <p class="text-gray-600 text-lg">検索中<span class="loading-dots"></span></p>
    </div>`;
    
    // ログアクションをサーバーに送信
    try {
      await fetch('/log_action', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'nearby_search',
          dataset: currentDataset,
          system: system,
          bus_stop_name: busStopName,
          place_name: busStopName || "検索地点"
        })
      });
    } catch (error) {
      console.error('Failed to log action:', error);
    }
    
    searchCircle = new google.maps.Circle({
      strokeColor: "#d4762a",
      strokeOpacity: 0.8,
      strokeWeight: 2,
      fillColor: "#d4762a",
      fillOpacity: 0.1,
      map: map,
      center: centerLatLng,
      radius: 500,
    });
    map.setCenter(centerLatLng);

    let keyword = window.selectedTheme;
    const service = new google.maps.places.PlacesService(map);
    const request = {
      location: centerLatLng,
      radius: window.mapConfig && window.mapConfig.map && window.mapConfig.map.radius
        ? window.mapConfig.map.radius
        : 500,
      keyword: keyword,
      type: "point_of_interest"
    };
    service.nearbySearch(request, (results, status) => {
      if (status === google.maps.places.PlacesServiceStatus.OK && results) {
        displayResultsAsList(results);
      } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
        document.getElementById('searchResultsList').innerHTML = `<div class="text-center py-12">
          <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <p class="text-gray-500 text-lg">検索結果が見つかりませんでした</p>
        </div>`;
      } else {
        document.getElementById('searchResultsList').innerHTML = `<div class="text-center py-12">
          <svg class="w-16 h-16 text-red-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <p class="text-red-500 text-lg">検索中にエラーが発生しました</p>
        </div>`;
      }
    });
  }
  
  function displayResultsAsList(results) {
    const resultsList = document.getElementById('searchResultsList');
    resultsList.innerHTML = "";
    searchMarkers.forEach(marker => marker.setMap(null));
    searchMarkers = [];
    const searchCenter = searchCircle ? searchCircle.getCenter() : null;
    if (results && results.length > 0 && searchCenter) {
      let filteredResults = [];
      results.forEach(place => {
        const distance = google.maps.geometry.spherical.computeDistanceBetween(
          searchCenter,
          place.geometry.location
        );
        if (distance <= 500) {
          filteredResults.push(place);
        }
      });
      if (filteredResults.length > 0) {
        const bounds = new google.maps.LatLngBounds();
        filteredResults.forEach((place, index) => {
          const marker = new google.maps.Marker({
            map: map,
            position: place.geometry.location,
            title: place.name,
            label: `${index + 1}`,
            animation: google.maps.Animation.DROP
          });
          searchMarkers.push(marker);
          bounds.extend(marker.getPosition());
          marker.addListener('click', () => {
            document.getElementById(`result-item-${index}`).scrollIntoView({
              behavior: 'smooth',
              block: 'center'
            });
          });
          const resultItem = document.createElement('div');
          resultItem.id = `result-item-${index}`;
          resultItem.className = 'bg-gray-50 rounded-lg p-6 border border-gray-200 hover:shadow-md transition-shadow duration-200';
          const address = place.vicinity || place.formatted_address || '住所情報なし';
          resultItem.innerHTML = `
            <div class="flex items-start space-x-4">
              <div class="flex-shrink-0 w-8 h-8 bg-kyoto-500 text-white rounded-full flex items-center justify-center font-semibold text-sm">
                ${index + 1}
              </div>
              <div class="flex-1 min-w-0">
                <h3 class="text-lg font-semibold text-gray-900 mb-1 flex items-center space-x-2">
                  <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}
                  ${place.geometry && place.geometry.location ? `%20@${place.geometry.location.lat()},${place.geometry.location.lng()}` : ''}"
                     target="_blank" rel="noopener noreferrer"
                     class="text-kyoto-600 hover:underline flex items-center"
                     data-lat="${place.geometry && place.geometry.location ? place.geometry.location.lat() : ''}"
                     data-lng="${place.geometry && place.geometry.location ? place.geometry.location.lng() : ''}"
                     onclick="event.stopPropagation();">
                    ${place.name}
                  </a>
                  ${
                    place.photos && place.photos.length > 0
                      ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}
                            ${place.geometry && place.geometry.location ? `%20@${place.geometry.location.lat()},${place.geometry.location.lng()}` : ''}"
                            target="_blank" rel="noopener noreferrer"
                            class="ml-2 px-2 py-1 bg-kyoto-200 text-kyoto-800 rounded hover:bg-kyoto-500 hover:text-white text-xs"
                            onclick="event.stopPropagation();">
                          MAPで詳細を見る
                        </a>`
                      : ''
                  }
                </h3>
                ${
                  place.rating
                    ? `<div class="flex items-center text-yellow-500 text-sm mb-1">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.967a1 1 0 00.95.69h4.175c.969 0 1.371 1.24.588 1.81l-3.38 2.455a1 1 0 00-.364 1.118l1.287 3.966c.3.922-.755 1.688-1.54 1.118l-3.38-2.454a1 1 0 00-1.175 0l-3.38 2.454c-.784.57-1.838-.196-1.54-1.118l1.287-3.966a1 1 0 00-.364-1.118L2.05 9.394c-.783-.57-.38-1.81.588-1.81h4.175a1 1 0 00.95-.69l1.286-3.967z"/>
                        </svg>
                        <span>${place.rating} / 5</span>
                        ${place.user_ratings_total ? `<span class="ml-2 text-gray-400">(${place.user_ratings_total}件)</span>` : ''}
                      </div>` : ''
                }
                <div class="flex items-center text-gray-500 text-sm mb-3">
                  <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                  </svg>
                  ${address}
                </div>
                <div class="bg-white rounded-lg p-4 border border-gray-100">
                  <div class="flex items-center text-sm text-gray-500 mb-2">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                    AI による詳細情報
                  </div>
                  <div class="ai-response text-gray-700">
                    <div class="flex items-center space-x-2">
                      <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-kyoto-500"></div>
                      <span class="text-sm text-gray-500">生成中<span class="loading-dots"></span></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
          document.getElementById('searchResultsList').appendChild(resultItem);
          requestGeminiDescription(place).then(response => {
            resultItem.querySelector('.ai-response').innerHTML = `<p class="leading-relaxed">${response}</p>`;
          });
        });
        if (searchCircle) {
          bounds.extend(searchCircle.getBounds().getNorthEast());
          bounds.extend(searchCircle.getBounds().getSouthWest());
        }
        map.fitBounds(bounds);
      } else {
        document.getElementById('searchResultsList').innerHTML = `<div class="text-center py-12">
          <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <p class="text-gray-500 text-lg">指定された範囲内に検索結果が見つかりませんでした</p>
        </div>`;
      }
    } else {
      document.getElementById('searchResultsList').innerHTML = `<div class="text-center py-12">
        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <p class="text-gray-500 text-lg">検索結果が見つかりませんでした</p>
      </div>`;
    }
  }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key={{ maps_api_key }}&libraries=places,geometry&callback=initMap&v=beta&rand={{ cache_buster }}" loading="async" async defer></script>
</body>
</html>